<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= hotel.name %> - Hotel Details</title>
    <link rel="stylesheet" href="/hotel-details.css">
  </head>
  <body>

    <a href="/hotels" class="back-btn">‚Üê Back to Hotels</a>
    <div class="container">
      <div class="header">
        <h1><%= hotel.name %></h1>
        <p><%= hotel.location %></p>

        <!-- Currency Selector -->
        <div class="currency-selector">
          <label for="currency">üí± View prices in:</label>
          <select id="currency">
            <option value="INR" selected>INR (‚Çπ)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (‚Ç¨)</option>
            <option value="GBP">GBP (¬£)</option>
          </select>
        </div>
      </div>

      <div class="content">
        <div class="hotel-info">
          <img
            src="<%= hotel.image %>"
            alt="<%= hotel.name %>"
            class="hotel-image"
          />

          <div class="info-section">
            <h3>üìç Location Details</h3>
            <p><strong>Address:</strong> <%= hotel.address %></p>
            <p><strong>City:</strong> <%= hotel.location %></p>

            <a href="/hotel/<%= hotel._id %>/map" class="directions-btn">
              üó∫Ô∏è View on Map
            </a>

            <% if (user) { %>
            <button id="wishlistBtn" style="margin-left:10px; padding:10px 14px; border:none; border-radius:8px; background:#ff3b3b; color:#fff; cursor:pointer;">
              ‚ù§Ô∏è Add to Wishlist
            </button>
            <span id="wishlistMsg" style="margin-left:8px; color:#28a745; display:none;">Added!</span>
            <% } %>
          </div>
        </div>

        <!-- Hotel Images Gallery -->
        <div style="max-width: 1200px; margin: 20px auto; text-align: center">
          <h2 style="color: #0f3460"><%= hotel.name %> - Images</h2>
          <% if (images.length > 0) { %>
          <div
            style="
              display: flex;
              gap: 10px;
              justify-content: center;
              flex-wrap: wrap;
            "
          >
            <% images.forEach(image => { %>
            <img
              src="<%= image %>"
              alt="Hotel Image"
              style="
                width: 300px;
                height: 200px;
                object-fit: cover;
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
              "
            />
            <% }) %>
          </div>
          <% } else { %>
          <p>No images available for this hotel.</p>
          <% } %>
        </div>

        <div class="rooms-section">
          <div class="info-section">
            <h3>üè® Available Rooms</h3>
            <div class="rooms-grid">
              <% hotel.rooms.forEach(room => { %>
              <div class="room-card">
                <div class="room-details">
                  <h4><%= room.type %></h4>
        
                  <div class="badges">
                    <span class="badge <%= room.ac ? 'ac' : 'non-ac' %>">
                      <%= room.ac ? "AC" : "Non-AC" %>
                    </span>
                    <span class="badge capacity">
                      üë• <%= room.capacity %> <%= room.capacity === 1 ? 'person' : 'people' %>
                    </span>
                  </div>
        
                  <% 
                    let statusClass = 'available'; 
                    let statusText = 'Available';
                    if (room.available === 0) { 
                      statusClass = 'sold-out'; 
                      statusText = 'Sold Out'; 
                    } else if (room.available <= 2) { 
                      statusClass = 'limited'; 
                      statusText = `Only ${room.available} left`; 
                    } else { 
                      statusText = `${room.available} rooms available`; 
                    } 
                  %>
        
                  <div class="availability <%= statusClass %>">
                    <%= statusText %>
                  </div>
        
                  <div class="price" data-base="<%= room.price %>">
                    ‚Çπ<%= room.price.toLocaleString() %> / night
                  </div>
                  <div class="converted-price"></div>
        
                  <% if (room.available > 0) { %>
                    <form action="/api/bookings" method="POST" class="booking-form">
                      <input type="hidden" name="hotelId" value="<%= hotel._id %>" />
                      <input type="hidden" name="roomType" value="<%= room.type %>" />
                    
                      <% if (user) { %>
                        <!-- Logged in user -->
                        <input type="hidden" name="userId" value="<%= user._id %>" />
                      <% } else { %>
                        <!-- Guest booking fields -->
                        <div class="guest-fields" style="border:1px solid #ccc; padding:15px; margin:15px 0; border-radius:8px; background:#f9f9f9; max-width:400px;">
                          <label for="guestName" style="display:block; margin-bottom:5px; font-weight:bold;">Name</label>
                          <input type="text" name="guestName" required placeholder="Enter your name"
                            style="width:100%; padding:8px; margin-bottom:12px; border:1px solid #ccc; border-radius:5px;" />
                        
                          <label for="guestEmail" style="display:block; margin-bottom:5px; font-weight:bold;">Email</label>
                          <input type="email" name="guestEmail" required placeholder="Enter your email"
                            style="width:100%; padding:8px; margin-bottom:12px; border:1px solid #ccc; border-radius:5px;" />
                        
                          <label for="guestPhone" style="display:block; margin-bottom:5px; font-weight:bold;">Phone</label>
                          <input type="tel" name="guestPhone" required placeholder="Enter your phone"
                            style="width:100%; padding:8px; margin-bottom:12px; border:1px solid #ccc; border-radius:5px;" />
                        
                          <input type="hidden" name="isGuestBooking" value="true" />
                        </div>
                        
                      <% } %>
                    
                      <!-- Dates -->
                      <div class="date-fields">
                        <input type="date" name="checkIn" required class="checkin-date" />
                        <input type="date" name="checkOut" required class="checkout-date" />
                      </div>
                    
                      <!-- Total Price -->
                      <div class="total-price">
                        Total: ‚Çπ<%= room.price.toLocaleString() %>
                      </div>
                    
                      <button type="submit" class="book-btn" data-base="<%= room.price %>">
                        <i class="fas fa-bed"></i> Book Now
                      </button>
                    </form>
                  <% } else { %>
                  <button class="book-btn" disabled>Sold Out</button>
                  <% } %>
                </div>
              </div>
              <% }) %>
            </div>
          </div>
        </div>

        <!-- Feedback Section -->
        <div class="info-section" style="margin-top:24px;">
          <h3>üó£Ô∏è Guest Feedback</h3>
          <div id="feedbackList" style="display:flex; flex-direction:column; gap:10px;"></div>

          <% if (user) { %>
          <form id="feedbackForm" style="margin-top:16px; max-width:520px;">
            <label style="display:block; margin-bottom:6px; font-weight:bold;">Rating (1-5)</label>
            <input type="number" name="rating" min="1" max="5" required style="width:120px; padding:8px; border:1px solid #ccc; border-radius:6px;" />
            <label style="display:block; margin:12px 0 6px; font-weight:bold;">Comment</label>
            <textarea name="comment" rows="3" placeholder="Share your experience" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px;"></textarea>
            <button type="submit" style="margin-top:12px; padding:10px 14px; border:none; border-radius:8px; background:#007bff; color:#fff; cursor:pointer;">Submit Feedback</button>
            <span id="feedbackMsg" style="margin-left:8px; color:#28a745; display:none;">Thanks for your feedback!</span>
          </form>
          <% } else { %>
            <p style="margin-top:10px;">Please <a href="/login">login</a> to add feedback.</p>
          <% } %>
        </div>
        
      </div>
    </div>

    <%- include('partials/footer') %>

    <script>
      // Currency symbols
      const currencySymbols = {
        INR: "‚Çπ",
        USD: "$",
        EUR: "‚Ç¨",
        GBP: "¬£",
      };

      // Live exchange rates (fetched from API)
      let rates = {
        INR: { symbol: "‚Çπ", rate: 1 },
        USD: { symbol: "$", rate: 0.012 },
        EUR: { symbol: "‚Ç¨", rate: 0.011 },
        GBP: { symbol: "¬£", rate: 0.0096 },
      };

      const currencySelector = document.getElementById("currency");

      // Fetch live exchange rates
      async function fetchExchangeRates() {
        try {
          const response = await fetch("/api/currency/rates?base=INR");
          const data = await response.json();

          if (data.rates) {
            rates = {
              INR: { symbol: currencySymbols.INR, rate: 1 },
              USD: {
                symbol: currencySymbols.USD,
                rate: data.rates.USD || 0.012,
              },
              EUR: {
                symbol: currencySymbols.EUR,
                rate: data.rates.EUR || 0.011,
              },
              GBP: {
                symbol: currencySymbols.GBP,
                rate: data.rates.GBP || 0.0096,
              },
            };

            console.log(
              "Exchange rates loaded:",
              rates,
              "Source:",
              data.source
            );
          }
        } catch (error) {
          console.warn(
            "Failed to fetch live rates, using fallback rates:",
            error
          );
        }
      }

      // Load exchange rates on page load
      fetchExchangeRates();

      currencySelector.addEventListener("change", () => {
        const selectedCurrency = currencySelector.value;
        const selectedRate = rates[selectedCurrency];

        // Update all room prices
        document.querySelectorAll(".price").forEach((priceEl) => {
          const basePrice = parseFloat(priceEl.dataset.base);
          const convertedPrice = (basePrice * selectedRate.rate).toFixed(2);
          priceEl.textContent = `${selectedRate.symbol}${parseFloat(
            convertedPrice
          ).toLocaleString()} / night`;
        });

        // Update converted price displays
        document
          .querySelectorAll(".converted-price")
          .forEach((convertedEl, index) => {
            const priceEl = document.querySelectorAll(".price")[index];
            const basePrice = parseFloat(priceEl.dataset.base);

            if (selectedCurrency !== "INR") {
              const convertedPrice = (basePrice * selectedRate.rate).toFixed(2);
              convertedEl.textContent = `‚âà ${selectedRate.symbol}${parseFloat(
                convertedPrice
              ).toLocaleString()}`;
              convertedEl.style.display = "block";
            } else {
              convertedEl.style.display = "none";
            }
          });

        // Update booking button prices
        document.querySelectorAll(".book-btn .btn-text").forEach((btnText) => {
          const button = btnText.closest(".book-btn");
          const basePrice = parseFloat(button.dataset.base);
          const convertedPrice = (basePrice * selectedRate.rate).toFixed(2);

          // Check if it's a user booking or guest booking button
          const isGuestBooking = btnText.textContent.includes("Book as Guest");
          const buttonText = isGuestBooking ? "Book as Guest" : "Book Now";

          btnText.textContent = `${buttonText} - ${
            selectedRate.symbol
          }${parseFloat(convertedPrice).toLocaleString()}`;
        });
      });

      // Initialize with INR (default)
      currencySelector.dispatchEvent(new Event("change"));
    </script>
   <script>
    document.querySelectorAll(".booking-form").forEach(form => {
      const checkin = form.querySelector(".checkin-date");
      const checkout = form.querySelector(".checkout-date");
      const totalPriceElem = form.querySelector(".total-price");
      const basePrice = parseInt(form.querySelector(".book-btn").dataset.base);
    
      function updatePrice() {
        if (checkin.value && checkout.value) {
          const inDate = new Date(checkin.value);
          const outDate = new Date(checkout.value);
          const nights = (outDate - inDate) / (1000 * 60 * 60 * 24);
    
          if (nights > 0) {
            totalPriceElem.textContent = `Total: ‚Çπ${(nights * basePrice).toLocaleString()}`;
          } else {
            totalPriceElem.textContent = `‚ö†Ô∏è Invalid dates`;
          }
        }
      }
    
      checkin.addEventListener("change", updatePrice);
      checkout.addEventListener("change", updatePrice);
    });
    </script>
    <script>
      // Wishlist
      const wishlistBtn = document.getElementById('wishlistBtn');
      if (wishlistBtn) {
        wishlistBtn.addEventListener('click', async () => {
          try {
            const res = await fetch('/api/wishlist/add', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ hotelId: '<%= hotel._id %>' })
            });
            if (res.ok) {
              document.getElementById('wishlistMsg').style.display = 'inline';
              wishlistBtn.textContent = '‚ù§Ô∏è Wishlisted';
              wishlistBtn.disabled = true;
              wishlistBtn.style.opacity = '0.7';
            }
          } catch (e) { console.error(e); }
        });
      }

      // Feedback - fetch list
      async function loadFeedback() {
        try {
          const res = await fetch('/api/feedback/hotel/<%= hotel._id %>');
          const data = await res.json();
          const box = document.getElementById('feedbackList');
          box.innerHTML = '';
          (data.feedback || []).forEach(f => {
            const div = document.createElement('div');
            div.style.border = '1px solid #e5e5e5';
            div.style.padding = '12px';
            div.style.borderRadius = '8px';
            div.innerHTML = `<strong>${(f.userId && f.userId.username) || 'User'}</strong> ‚Ä¢ ‚≠ê ${f.rating}<br>${f.comment || ''}`;
            box.appendChild(div);
          });
          if (!data.feedback || data.feedback.length === 0) {
            box.innerHTML = '<p>No feedback yet.</p>';
          }
        } catch (e) { console.error(e); }
      }
      loadFeedback();

      // Feedback - submit
      const feedbackForm = document.getElementById('feedbackForm');
      if (feedbackForm) {
        feedbackForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(feedbackForm);
          const payload = {
            hotelId: '<%= hotel._id %>',
            rating: Number(formData.get('rating')),
            comment: formData.get('comment') || ''
          };
          try {
            const res = await fetch('/api/feedback/submit', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (res.ok) {
              document.getElementById('feedbackMsg').style.display = 'inline';
              feedbackForm.reset();
              loadFeedback();
            }
          } catch (e) { console.error(e); }
        });
      }
    </script>
    
    
  </body>
</html>
