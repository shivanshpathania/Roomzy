<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Available Hotels</title>
    <link rel="icon" type="image/jpeg" href="images/favicon-32x32.png">
    <link rel="stylesheet" href="/hotels.css">
  </head>

  <body>
    <header style="background-color: #0f3460; color: white; padding: 10px 20px;">
      <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">
          <!-- Logo -->
          <div style="flex: 1;">
              <a href="/" style="color: #fdb827; text-decoration: none; font-size: 1.5em; font-weight: bold;">
                  Roomzy
              </a>
          </div>
  
          <!-- Navigation Links -->
          <nav style="flex: 2; text-align: center;">
              <a href="/home" style="color: white; text-decoration: none; margin: 0 15px;">Home</a>
              <a href="/user/bookings" style="color: white; text-decoration: none; margin: 0 15px;">Your Bookings</a>
              <a href="/login" style="color: white; text-decoration: none; margin: 0 15px;">Login</a>
              <a href="/signup" style="color: white; text-decoration: none; margin: 0 15px;">Signup</a>
          </nav>
  
          <!-- Currency Selector -->
          <div style="flex: 1; text-align: right;">
            <a href="/profile" style="color: white; text-decoration: none; margin: 0 15px;">Profile</a>
          </div>
      </div>
  </header>


  <% if (user) { %>
    <h2 style="text-align: center; text-transform: capitalize">
      <span style="color: #0c218b">Welcome :</span> <%= user.username %>
    </h2>
    <% } else { %>
    <h2 style="text-align: center; text-transform: capitalize">
      <span style="color: #0c218b">Welcome, Guest!</span>
    </h2>
    <% } %>
  
<!-- üîç Search -->
<div class="search-container">
  <input type="text" id="hotelSearch" placeholder="Search hotels by name or city..." />
  <button id="hotelSearchButton">Search</button>
</div>

<!-- üè∑Ô∏è Filters -->
<div class="filter-section">
  <form id="filterForm" class="filter-form">
    <!-- Price -->
    <label for="priceFilter">Price:</label>
    <select id="priceFilter">
      <option value="">Any</option>
      <option value="0-1000">‚Çπ0 - ‚Çπ1000</option>
      <option value="1000-3000">‚Çπ1000 - ‚Çπ3000</option>
      <option value="3000-5000">‚Çπ3000 - ‚Çπ5000</option>
      <option value="5000+">‚Çπ5000+</option>
    </select>

    <!-- Rating -->
    <label for="ratingFilter">Rating:</label>
    <select id="ratingFilter">
      <option value="">Any</option>
      <option value="5">5‚òÖ</option>
      <option value="4">4‚òÖ & above</option>
      <option value="3">3‚òÖ & above</option>
    </select>

    <!-- Apply Button -->
    <button id="filterButton" type="button">Apply Filters</button>

    <% if (user) { %>
    <!-- Wishlist filter -->
    <label style="margin-left:12px;">
      <input type="checkbox" id="onlyWishlist" /> Show only wishlist
    </label>
    <% } %>
  </form>
</div>


  <!-- üè® Hotel List -->
  <div class="hotel-list">
    <% hotels.forEach(hotel => { %>
    <div
      class="hotel-card"
      data-id="<%= hotel._id %>"
      data-name="<%= hotel.name.toLowerCase() %>"
      data-city="<%= hotel.location.toLowerCase() %>"
      data-price="<%= hotel.price %>"
      data-rating="<%= hotel.rating %>"
    >
      <img src="<%= hotel.image %>" alt="<%= hotel.name %>" />
      <h2><%= hotel.name %></h2>
      
      <p><strong>Location:</strong> <%= hotel.location %></p>
      <p><strong>Rating:</strong>
        <% for (let i = 0; i < hotel.rating; i++) { %>
          ‚òÖ
        <% } %>
        <% for (let i = hotel.rating; i < 5; i++) { %>
          ‚òÜ
        <% } %>
      </p>
      <p class="weather" id="weather-<%= hotel._id %>">Loading weather...</p>
  
      <!-- Buttons -->
      <div style="margin: 15px 0; text-align: center">
        <a href="/hotel/<%= hotel._id %>" style="padding:8px 12px; background:#007BFF; color:white; border-radius:5px; text-decoration:none; margin-right:8px;">
          üè® View Details
        </a>
        <a href="/hotel/<%= hotel._id %>/map" style="padding:8px 12px; background:#28A745; color:white; border-radius:5px; text-decoration:none;">
          üó∫Ô∏è View Map
        </a>
      </div>
    </div>
    <% }) %>
  </div>
  

    <%- include('partials/footer') %>

    <script>
      //  Fetch weather for each hotel from backend
      document.querySelectorAll(".hotel-card").forEach((card) => {
        const city = card.getAttribute("data-city");
        const weatherElement = card.querySelector(".weather");

        fetch(`/api/weather/${city}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.main) {
              const temp = data.main.temp;
              const description = data.weather[0].description;
              weatherElement.textContent = `Weather: ${temp}¬∞C, ${description}`;
            } else {
              weatherElement.textContent = "Weather data not available";
            }
          })
          .catch(() => {
            weatherElement.textContent = "Error fetching weather data";
          });
      });

      // ‚úÖ Hotel search filter
      document
        .getElementById("searchButton")
        .addEventListener("click", function () {
          const query = document
            .getElementById("hotelSearch")
            .value.toLowerCase();
          const hotelCards = document.querySelectorAll(".hotel-card");

          hotelCards.forEach((card) => {
            const hotelName = card.getAttribute("data-name").toLowerCase();
            const hotelCity = card.getAttribute("data-city").toLowerCase();
            if (hotelName.includes(query) || hotelCity.includes(query)) {
              card.style.display = "block";
            } else {
              card.style.display = "none";
            }
          });
        });

      // ‚úÖ Currency conversion with live API rates
      const currencySymbols = {
        INR: "‚Çπ",
        USD: "$",
        EUR: "‚Ç¨",
        GBP: "¬£",
      };

      // Live exchange rates (fetched from API)
      let rates = {
        INR: { symbol: "‚Çπ", rate: 1 },
        USD: { symbol: "$", rate: 0.012 },
        EUR: { symbol: "‚Ç¨", rate: 0.011 },
        GBP: { symbol: "¬£", rate: 0.0096 },
      };

      const selector = document.getElementById("currency");

      // Fetch live exchange rates
      async function fetchExchangeRates() {
        try {
          const response = await fetch("/api/currency/rates?base=INR");
          const data = await response.json();

          if (data.rates) {
            rates = {
              INR: { symbol: currencySymbols.INR, rate: 1 },
              USD: {
                symbol: currencySymbols.USD,
                rate: data.rates.USD || 0.012,
              },
              EUR: {
                symbol: currencySymbols.EUR,
                rate: data.rates.EUR || 0.011,
              },
              GBP: {
                symbol: currencySymbols.GBP,
                rate: data.rates.GBP || 0.0096,
              },
            };
            console.log("Live exchange rates loaded:", rates);
          }
        } catch (error) {
          console.warn(
            "Failed to fetch live rates, using fallback rates:",
            error
          );
        }
      }

      // Load exchange rates on page load
      fetchExchangeRates();

      if (selector) {
        selector.addEventListener("change", () => {
          const selected = selector.value;
          const prices = document.querySelectorAll(".price");

          prices.forEach((priceEl) => {
            const base = parseFloat(priceEl.dataset.base); // base INR price
            const converted = (base * rates[selected].rate).toFixed(2);
            priceEl.textContent = `${rates[selected].symbol}${converted}`;
          });
        });
      }
    </script>
<script>
  // üîç Hotel search by name or city
  document.getElementById("hotelSearchButton").addEventListener("click", function () {
    const query = document.getElementById("hotelSearch").value.toLowerCase();
    const hotelCards = document.querySelectorAll(".hotel-card");

    hotelCards.forEach((card) => {
      const hotelName = card.getAttribute("data-name").toLowerCase();
      const hotelCity = card.getAttribute("data-city").toLowerCase();
      if (hotelName.includes(query) || hotelCity.includes(query)) {
        card.style.display = "block";
      } else {
        card.style.display = "none";
      }
    });
  });

  // üè∑Ô∏è Apply filters (price + rating)
  document.getElementById("filterButton").addEventListener("click", function () {
    const priceVal = document.getElementById("priceFilter").value;
    const ratingVal = document.getElementById("ratingFilter").value;

    document.querySelectorAll(".hotel-card").forEach((card) => {
      const price = parseFloat(card.dataset.price);
      const rating = parseFloat(card.dataset.rating);
      let visible = true;

      // üí∞ Price filter
      if (priceVal) {
        if (priceVal.includes("+")) {
          visible = visible && price >= parseInt(priceVal);
        } else {
          const [min, max] = priceVal.split("-").map(Number);
          visible = visible && price >= min && price <= max;
        }
      }

      // ‚≠ê Rating filter
      if (ratingVal) {
        visible = visible && rating >= parseInt(ratingVal);
      }

      card.style.display = visible ? "block" : "none";
    });
  });
</script>
<script>
  // ‚≠ê Wishlist filter
  <% if (user) { %>
  let wishlistHotelIds = new Set();
  (async function loadWishlist() {
    try {
      const res = await fetch('/api/wishlist/me');
      const data = await res.json();
      const hotels = data.wishlist || [];
      wishlistHotelIds = new Set(hotels.map(h => h._id));

      // Mark wishlisted cards (optional visual cue)
      document.querySelectorAll('.hotel-card').forEach(card => {
        const id = card.getAttribute('data-id');
        if (wishlistHotelIds.has(id)) {
          const tag = document.createElement('div');
          tag.textContent = '‚ù§Ô∏è In wishlist';
          tag.style.color = '#ff3b3b';
          tag.style.fontWeight = 'bold';
          tag.style.marginTop = '6px';
          card.querySelector('h2').after(tag);
        }
      });
    } catch (e) { console.error('Wishlist load failed', e); }
  })();

  const onlyWishlist = document.getElementById('onlyWishlist');
  onlyWishlist && onlyWishlist.addEventListener('change', () => {
    const showOnly = onlyWishlist.checked;
    document.querySelectorAll('.hotel-card').forEach(card => {
      const id = card.getAttribute('data-id');
      const inWishlist = wishlistHotelIds.has(id);
      card.style.display = showOnly ? (inWishlist ? 'block' : 'none') : 'block';
    });
  });
  <% } %>
</script>


  
  
  
  
  </body>
</html>
